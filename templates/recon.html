{% extends "base.html" %}

{% block title %}Reconnaissance - Bug Hunter{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Recon</li>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-4 border-bottom">
    <h1 class="h2 text-gradient">
        <i class="fas fa-search me-3"></i>
        Reconnaissance Center
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newCampaignModal">
            <i class="fas fa-plus me-2"></i>New Campaign
        </button>
    </div>
</div>

<!-- Script Editor Section -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-code me-2"></i>
                    Bash Script Editor
                </h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="loadDefaultScript()" data-bs-toggle="tooltip" title="Load Default Script">
                        <i class="fas fa-file-import"></i>
                    </button>
                    <button class="btn btn-outline-primary" onclick="formatScript()" data-bs-toggle="tooltip" title="Format Code">
                        <i class="fas fa-align-left"></i>
                    </button>
                    <button class="btn btn-outline-primary" onclick="toggleFullscreen()" data-bs-toggle="tooltip" title="Toggle Fullscreen">
                        <i class="fas fa-expand"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="row g-0">
                    <div class="col-12" id="editorContainer">
                        <textarea id="scriptEditor" class="code-editor w-100" rows="20" style="resize: vertical; border: none; outline: none; padding: 1rem;">#!/bin/bash

# Bug Hunter's Reconnaissance Script
# Intelligent scope-based recon automation for Kali Linux
# Version: 1.0

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Global variables
TARGET=""
OUTPUT_DIR=""
SCOPE_SIZE=""
SUBDOMAIN_COUNT=0
LIVE_HOST_COUNT=0

# Logging function
log() {
    echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')] $1${NC}"
}

error() {
    echo -e "${RED}[ERROR] $1${NC}"
}

# Fast subdomain enumeration
fast_subdomain_enum() {
    log "Starting fast subdomain enumeration for $TARGET..."

    # Subfinder - passive enumeration
    subfinder -d "$TARGET" -all -silent > "$OUTPUT_DIR/subdomains_subfinder.txt"

    # Assetfinder - additional sources
    assetfinder --subs-only "$TARGET" > "$OUTPUT_DIR/subdomains_assetfinder.txt"

    # Certificate transparency
    curl -s "https://crt.sh/?q=%.$TARGET&output=json" | jq -r '.[].name_value' | sed 's/\*.//g' | sort -u > "$OUTPUT_DIR/subdomains_crtsh.txt"

    # Combine and count
    cat "$OUTPUT_DIR"/subdomains_*.txt | sort -u > "$OUTPUT_DIR/all_subdomains.txt"
    SUBDOMAIN_COUNT=$(wc -l < "$OUTPUT_DIR/all_subdomains.txt")

    log "Found $SUBDOMAIN_COUNT subdomains"
}

# Host discovery
host_discovery() {
    log "Starting host discovery..."

    # Check live hosts
    httpx -l "$OUTPUT_DIR/all_subdomains.txt" -silent -timeout 10 > "$OUTPUT_DIR/live_hosts.txt"
    LIVE_HOST_COUNT=$(wc -l < "$OUTPUT_DIR/live_hosts.txt")

    log "Found $LIVE_HOST_COUNT live hosts"
}

# Scope classification
classify_scope() {
    if [ "$SUBDOMAIN_COUNT" -lt 50 ] && [ "$LIVE_HOST_COUNT" -lt 10 ]; then
        SCOPE_SIZE="SMALL"
    elif [ "$SUBDOMAIN_COUNT" -le 300 ] && [ "$LIVE_HOST_COUNT" -lt 100 ]; then
        SCOPE_SIZE="MEDIUM"
    else
        SCOPE_SIZE="LARGE"
    fi

    log "Target classified as: $SCOPE_SIZE scope"
}

# Main function
main() {
    TARGET="$1"

    if [ -z "$TARGET" ]; then
        error "Usage: $0 <target_domain>"
        exit 1
    fi

    OUTPUT_DIR="results/$TARGET/$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$OUTPUT_DIR"

    log "Starting reconnaissance for: $TARGET"

    # Execute reconnaissance modules
    fast_subdomain_enum
    host_discovery
    classify_scope

    # Additional modules based on scope
    case $SCOPE_SIZE in
        "SMALL")
            log "Executing SMALL scope reconnaissance..."
            # Add small scope specific tools here
            ;;
        "MEDIUM")
            log "Executing MEDIUM scope reconnaissance..."
            # Add medium scope specific tools here
            ;;
        "LARGE")
            log "Executing LARGE scope reconnaissance..."
            # Add large scope specific tools here
            ;;
    esac

    log "Reconnaissance completed! Results saved to: $OUTPUT_DIR"
}

# Execute main function with arguments
main "$@"</textarea>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveScript()">
                            <i class="fas fa-save me-2"></i>Save Script
                        </button>
                        <button class="btn btn-primary" onclick="runScript()">
                            <i class="fas fa-play me-2"></i>Run Script
                        </button>
                        <button class="btn btn-outline-primary" onclick="validateScript()">
                            <i class="fas fa-check me-2"></i>Validate
                        </button>
                    </div>
                    <div class="text-secondary small">
                        <i class="fas fa-info-circle me-1"></i>
                        Lines: <span id="lineCount">0</span> | 
                        Characters: <span id="charCount">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Campaign Results -->
<div class="row g-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    Campaign Results
                </h5>
                <div class="d-flex gap-2">
                    <div class="input-group input-group-sm" style="width: 300px;">
                        <input type="text" class="form-control" placeholder="Search campaigns..." id="searchCampaigns">
                        <button class="btn btn-outline-primary" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-filter me-1"></i>Filter
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="filterCampaigns('all')">All Status</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterCampaigns('running')">Running</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterCampaigns('completed')">Completed</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterCampaigns('failed')">Failed</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                {% if campaigns %}
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0" id="campaignsTable">
                        <thead>
                            <tr>
                                <th><i class="fas fa-globe me-2"></i>Target Domain</th>
                                <th><i class="fas fa-layer-group me-2"></i>Scope Size</th>
                                <th><i class="fas fa-traffic-light me-2"></i>Status</th>
                                <th><i class="fas fa-sitemap me-2"></i>Subdomains</th>
                                <th><i class="fas fa-server me-2"></i>Live Hosts</th>
                                <th><i class="fas fa-shield-alt me-2"></i>Vulnerabilities</th>
                                <th><i class="fas fa-clock me-2"></i>Created</th>
                                <th><i class="fas fa-cogs me-2"></i>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for campaign in campaigns %}
                            <tr data-status="{{ campaign.status }}" data-domain="{{ campaign.target_domain }}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-globe text-primary me-2"></i>
                                        <strong>{{ campaign.target_domain }}</strong>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge" style="background: var(--gradient-primary)">
                                        {{ campaign.scope_size or 'auto' }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-{% if campaign.status == 'completed' %}success{% elif campaign.status == 'running' %}primary{% elif campaign.status == 'failed' %}danger{% else %}warning{% endif %}" data-status="{{ campaign.status }}">
                                        <i class="fas fa-{% if campaign.status == 'completed' %}check{% elif campaign.status == 'running' %}spinner fa-spin{% elif campaign.status == 'failed' %}times{% else %}clock{% endif %} me-1"></i>
                                        {{ campaign.status.title() }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ campaign.subdomain_count or 0 }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-success">{{ campaign.live_host_count or 0 }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-{% if campaign.vulnerability_count and campaign.vulnerability_count > 0 %}danger{% else %}secondary{% endif %}">
                                        {{ campaign.vulnerability_count or 0 }}
                                    </span>
                                </td>
                                <td>
                                    <small class="text-secondary">{{ campaign.created_at }}</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary btn-sm" onclick="viewCampaignDetails('{{ campaign.id }}')" data-bs-toggle="tooltip" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if campaign.status == 'completed' %}
                                        <button class="btn btn-outline-success btn-sm" onclick="downloadResults('{{ campaign.id }}')" data-bs-toggle="tooltip" title="Download Results">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        {% endif %}
                                        {% if campaign.status in ['pending', 'failed'] %}
                                        <button class="btn btn-outline-warning btn-sm" onclick="rerunCampaign('{{ campaign.id }}')" data-bs-toggle="tooltip" title="Rerun Campaign">
                                            <i class="fas fa-redo"></i>
                                        </button>
                                        {% endif %}
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteCampaign('{{ campaign.id }}')" data-bs-toggle="tooltip" title="Delete Campaign">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-search fa-4x text-secondary"></i>
                    </div>
                    <h4 class="text-secondary mb-2">No campaigns yet</h4>
                    <p class="text-secondary mb-4">Start your first reconnaissance campaign to see results here</p>
                    <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#newCampaignModal">
                        <i class="fas fa-rocket me-2"></i>Start First Campaign
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- New Campaign Modal -->
<div class="modal fade" id="newCampaignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>New Reconnaissance Campaign
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newCampaignForm">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label for="targetDomain" class="form-label">Target Domain</label>
                            <input type="text" class="form-control" id="targetDomain" required placeholder="example.com">
                            <div class="form-text">Enter the domain to reconnaissance (without protocol)</div>
                        </div>
                        <div class="col-md-4">
                            <label for="scopeSize" class="form-label">Scope Size</label>
                            <select class="form-select" id="scopeSize">
                                <option value="auto" selected>Auto-detect</option>
                                <option value="small">Small (&lt;50 subdomains)</option>
                                <option value="medium">Medium (50-300 subdomains)</option>
                                <option value="large">Large (&gt;300 subdomains)</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Reconnaissance Options</label>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enableSubdomainEnum" checked>
                                        <label class="form-check-label" for="enableSubdomainEnum">
                                            Subdomain Enumeration
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enablePortScan" checked>
                                        <label class="form-check-label" for="enablePortScan">
                                            Port Scanning
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enableVulnScan" checked>
                                        <label class="form-check-label" for="enableVulnScan">
                                            Vulnerability Scanning
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enableWebCrawl" checked>
                                        <label class="form-check-label" for="enableWebCrawl">
                                            Web Crawling
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enableOSINT" checked>
                                        <label class="form-check-label" for="enableOSINT">
                                            OSINT Collection
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enableTechStack">
                                        <label class="form-check-label" for="enableTechStack">
                                            Technology Stack Analysis
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <label for="campaignNotes" class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" id="campaignNotes" rows="3" placeholder="Add any specific notes or objectives for this campaign..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="startCampaign()">
                    <i class="fas fa-rocket me-2"></i>Start Campaign
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let editor = document.getElementById('scriptEditor');

// Script editor functionality
function updateCounts() {
    const content = editor.value;
    const lines = content.split('\n').length;
    const chars = content.length;

    document.getElementById('lineCount').textContent = lines;
    document.getElementById('charCount').textContent = chars;
}

// Update counts on input
editor.addEventListener('input', updateCounts);
document.addEventListener('DOMContentLoaded', updateCounts);

function saveScript() {
    const content = editor.value;
    const blob = new Blob([content], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'recon-script.sh';
    a.click();
    URL.revokeObjectURL(url);

    // Show success message
    showToast('Script saved successfully!', 'success');
}

function runScript() {
    const targetDomain = prompt('Enter target domain to run reconnaissance:');
    if (targetDomain) {
        startCampaignWithDomain(targetDomain);
    }
}

function validateScript() {
    const content = editor.value;
    let issues = [];

    // Basic validation
    if (!content.startsWith('#!/bin/bash')) {
        issues.push('Script should start with shebang (#!/bin/bash)');
    }

    if (!content.includes('main')) {
        issues.push('Script should have a main function');
    }

    if (issues.length === 0) {
        showToast('Script validation passed!', 'success');
    } else {
        showToast('Validation issues: ' + issues.join(', '), 'warning');
    }
}

function loadDefaultScript() {
    // Already loaded in the textarea
    showToast('Default script loaded!', 'info');
}

function formatScript() {
    // Basic formatting
    let content = editor.value;
    content = content.replace(/\t/g, '    '); // Replace tabs with 4 spaces
    editor.value = content;
    showToast('Script formatted!', 'info');
}

function toggleFullscreen() {
    const container = document.getElementById('editorContainer');
    if (!document.fullscreenElement) {
        container.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

// Campaign management
function startCampaign() {
    const targetDomain = document.getElementById('targetDomain').value;
    const scopeSize = document.getElementById('scopeSize').value;
    const notes = document.getElementById('campaignNotes').value;

    if (!targetDomain) {
        showToast('Please enter a target domain', 'error');
        return;
    }

    // Basic domain validation
    const domainRegex = /^[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9]\.[a-zA-Z]{2,}$/;
    if (!domainRegex.test(targetDomain)) {
        showToast('Please enter a valid domain name', 'error');
        return;
    }

    startCampaignWithDomain(targetDomain, scopeSize, notes);
}

function startCampaignWithDomain(domain, scope = 'auto', notes = '') {
    fetch('/api/recon/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            target_domain: domain,
            scope_size: scope,
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'started') {
            showToast('Campaign started successfully for ' + domain, 'success');
            document.getElementById('newCampaignModal').querySelector('.btn-close').click();
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error starting campaign: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Network error: ' + error.message, 'error');
    });
}

function viewCampaignDetails(campaignId) {
    window.location.href = '/recon/campaign/' + campaignId;
}

function downloadResults(campaignId) {
    window.open('/api/campaigns/' + campaignId + '/download', '_blank');
}

function rerunCampaign(campaignId) {
    if (confirm('Are you sure you want to rerun this campaign?')) {
        fetch('/api/campaigns/' + campaignId + '/rerun', {method: 'POST'})
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showToast('Campaign restarted successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Error rerunning campaign: ' + data.error, 'error');
            }
        })
        .catch(error => showToast('Network error: ' + error.message, 'error'));
    }
}

function deleteCampaign(campaignId) {
    if (confirm('Are you sure you want to delete this campaign? This action cannot be undone.')) {
        fetch('/api/campaigns/' + campaignId, {method: 'DELETE'})
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showToast('Campaign deleted successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Error deleting campaign: ' + data.error, 'error');
            }
        })
        .catch(error => showToast('Network error: ' + error.message, 'error'));
    }
}

// Search and filter functionality
document.getElementById('searchCampaigns').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#campaignsTable tbody tr');

    rows.forEach(row => {
        const domain = row.getAttribute('data-domain').toLowerCase();
        if (domain.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

function filterCampaigns(status) {
    const rows = document.querySelectorAll('#campaignsTable tbody tr');

    rows.forEach(row => {
        const rowStatus = row.getAttribute('data-status');
        if (status === 'all' || rowStatus === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Toast notification function
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(toast);

    // Auto dismiss after 5 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 5000);
}

// Add syntax highlighting to the editor
Prism.highlightAll();
</script>
{% endblock %}
