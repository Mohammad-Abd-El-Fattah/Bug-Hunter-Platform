{% extends "base.html" %}

{% block title %}Exploit Scripts - Bug Hunter Enhanced{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 text-dark fw-bold">
                    <i class="bi bi-code-slash me-2"></i>Exploit Scripts
                </h1>
                <p class="text-muted">Upload and execute exploit scripts on discovered vulnerabilities</p>
            </div>
            <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#uploadScriptModal">
                <i class="bi bi-upload me-2"></i>Upload Script
            </button>
        </div>
    </div>
</div>

<!-- Scripts Grid -->
<div class="row g-4" id="scriptsGrid">
    {% for script in scripts %}
    <div class="col-lg-4 col-md-6" data-script-id="{{ script.id }}">
        <div class="card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="card-title">{{ script.name }}</h5>
                        <span class="badge bg-danger">Exploit</span>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="#" onclick="viewScript({{ script.id }})">
                                    <i class="bi bi-eye me-2"></i>View Script
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="runScript({{ script.id }})">
                                    <i class="bi bi-play-circle me-2"></i>Run Script
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item text-danger" href="#" onclick="deleteScript({{ script.id }})">
                                    <i class="bi bi-trash me-2"></i>Delete
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div class="mb-3">
                    <p class="text-muted">{{ script.description or 'No description available' }}</p>
                    <div class="d-flex gap-2 mb-2">
                        <span class="badge bg-secondary">{{ script.language or 'bash' }}</span>
                        {% if script.status %}
                        <span class="script-status {{ script.status }}">
                            {% if script.status == 'running' %}
                                <i class="bi bi-play-circle"></i>
                            {% elif script.status == 'completed' %}
                                <i class="bi bi-check-circle"></i>
                            {% elif script.status == 'failed' %}
                                <i class="bi bi-x-circle"></i>
                            {% else %}
                                <i class="bi bi-circle"></i>
                            {% endif %}
                            {{ script.status.title() }}
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        {{ script.created_at.split(' ')[0] if script.created_at else 'Unknown' }}
                    </small>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-success" onclick="runScript({{ script.id }})" title="Run Script">
                            <i class="bi bi-play-circle"></i>
                        </button>
                        <button class="btn btn-outline-primary" onclick="viewScript({{ script.id }})" title="View">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="text-center py-5">
            <i class="bi bi-code-slash text-muted" style="font-size: 4rem;"></i>
            <h4 class="text-muted mt-3">No exploit scripts uploaded</h4>
            <p class="text-muted">Upload your first exploit script to get started</p>
            <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#uploadScriptModal">
                <i class="bi bi-upload me-2"></i>Upload Your First Script
            </button>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Upload Script Modal -->
<div class="modal fade" id="uploadScriptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-upload me-2"></i>Upload Exploit Script
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="uploadScriptForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label for="scriptName" class="form-label">Script Name</label>
                            <input type="text" class="form-control" id="scriptName" name="name" required
                                   placeholder="SQL Injection Exploit">
                        </div>
                        
                        <div class="col-md-4">
                            <label for="scriptLanguage" class="form-label">Language</label>
                            <select class="form-select" id="scriptLanguage" name="language">
                                <option value="bash">Bash</option>
                                <option value="python">Python</option>
                                <option value="perl">Perl</option>
                                <option value="ruby">Ruby</option>
                                <option value="powershell">PowerShell</option>
                            </select>
                        </div>
                        
                        <div class="col-12">
                            <label for="scriptDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="scriptDescription" name="description" rows="3"
                                      placeholder="Describe what this exploit script does and when to use it"></textarea>
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label">Upload Script File</label>
                            <div class="file-upload-zone" onclick="document.getElementById('scriptFile').click()">
                                <input type="file" id="scriptFile" name="script_file" accept=".sh,.py,.pl,.rb,.ps1" required hidden>
                                <div class="file-upload-icon">
                                    <i class="bi bi-file-earmark-code"></i>
                                </div>
                                <div class="file-upload-text">
                                    Click to select exploit script file
                                </div>
                                <div class="file-upload-subtext">
                                    Supported: .sh, .py, .pl, .rb, .ps1 (Max 10MB)
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Security Warning:</strong>
                                Only upload exploit scripts from trusted sources. Scripts will be executed with system privileges.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-gradient">
                        <i class="bi bi-upload me-2"></i>Upload Script
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Run Script Modal -->
<div class="modal fade" id="runScriptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-play-circle me-2"></i>
                    <span id="runScriptTitle">Run Exploit Script</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="runScriptForm">
                <div class="modal-body">
                    <input type="hidden" id="runScriptId" name="script_id">
                    
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Target Selection</label>
                            <div id="targetSelector">
                                <!-- Target options will be loaded here -->
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="targetUrl" class="form-label">Target URL/IP</label>
                            <input type="text" class="form-control" id="targetUrl" name="target_url"
                                   placeholder="https://target.com or 192.168.1.100">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="targetPort" class="form-label">Port (Optional)</label>
                            <input type="number" class="form-control" id="targetPort" name="target_port"
                                   placeholder="80, 443, 8080">
                        </div>
                        
                        <div class="col-12">
                            <label for="scriptArgs" class="form-label">Script Arguments (Optional)</label>
                            <textarea class="form-control" id="scriptArgs" name="script_args" rows="3"
                                      placeholder="Additional arguments to pass to the exploit script"></textarea>
                        </div>
                        
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="saveResults" name="save_results" checked>
                                <label class="form-check-label" for="saveResults">
                                    Save execution results for analysis
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <strong>Warning:</strong> Only run exploit scripts against targets you own or have explicit permission to test.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-play-circle me-2"></i>Execute Exploit
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Script Modal -->
<div class="modal fade" id="viewScriptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-eye me-2"></i>
                    <span id="viewScriptTitle">Script Preview</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="scriptPreview">
                    <!-- Script content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" onclick="runScriptFromView()">
                    <i class="bi bi-play-circle me-2"></i>Run Script
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Execution Log Modal -->
<div class="modal fade" id="executionLogModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-terminal me-2"></i>Execution Log
                </h5>
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline-danger" id="stopExecution">
                        <i class="bi bi-stop-circle me-1"></i>Stop
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>Status:</strong>
                        <span id="executionStatus" class="script-status pending">Initializing...</span>
                    </div>
                </div>
                <div class="log-viewer" id="executionLog">
                    <!-- Execution log will be streamed here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-primary" onclick="downloadLog()">
                    <i class="bi bi-download me-2"></i>Download Log
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteScriptModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this exploit script?</p>
                <p class="text-muted small">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteScript">
                    <i class="bi bi-trash me-2"></i>Delete Script
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentScriptId = null;
let currentExecutionId = null;
let logViewer = null;

// Upload script form handling
document.getElementById('uploadScriptForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    try {
        await API.uploadExploitScript(formData);
        
        API.showToast('Exploit script uploaded successfully!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('uploadScriptModal')).hide();
        
        setTimeout(() => location.reload(), 1000);
        
    } catch (error) {
        API.showToast(error.message || 'Error uploading script', 'error');
    }
});

// View script
async function viewScript(scriptId) {
    try {
        const response = await API.request(`/api/exploit/scripts/${scriptId}`);
        const script = response.data;
        
        document.getElementById('viewScriptTitle').textContent = script.name;
        
        const preview = document.getElementById('scriptPreview');
        preview.innerHTML = `
            <div class="mb-3">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Language:</strong> ${script.language || 'bash'}
                    </div>
                    <div class="col-md-6">
                        <strong>File:</strong> ${script.filename || 'Unknown'}
                    </div>
                </div>
                ${script.description ? `
                <div class="mt-2">
                    <strong>Description:</strong>
                    <p class="text-muted">${script.description}</p>
                </div>
                ` : ''}
            </div>
            <div class="code-editor">
                <pre><code>${script.content || 'Script content not available'}</code></pre>
            </div>
        `;
        
        currentScriptId = scriptId;
        new bootstrap.Modal(document.getElementById('viewScriptModal')).show();
        
    } catch (error) {
        API.showToast('Error loading script', 'error');
    }
}

// Run script
function runScript(scriptId) {
    currentScriptId = scriptId;
    document.getElementById('runScriptId').value = scriptId;
    
    // Load available targets
    loadTargetSelector();
    
    new bootstrap.Modal(document.getElementById('runScriptModal')).show();
}

// Run script from view modal
function runScriptFromView() {
    bootstrap.Modal.getInstance(document.getElementById('viewScriptModal')).hide();
    runScript(currentScriptId);
}

// Load target selector
async function loadTargetSelector() {
    try {
        const response = await API.getTargets();
        const targets = response.data || [];
        
        const selector = document.getElementById('targetSelector');
        
        if (targets.length === 0) {
            selector.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    No saved targets available. Enter target details manually below.
                </div>
            `;
            return;
        }
        
        const targetsHtml = targets.map(target => `
            <div class="form-check">
                <input class="form-check-input" type="radio" name="selected_target" id="target_${target.id}" value="${target.id}">
                <label class="form-check-label" for="target_${target.id}">
                    <strong>${target.domain}</strong>
                    <small class="text-muted d-block">${target.url || target.domain}</small>
                </label>
            </div>
        `).join('');
        
        selector.innerHTML = targetsHtml;
        
    } catch (error) {
        console.error('Error loading targets:', error);
        document.getElementById('targetSelector').innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Could not load saved targets. Enter target details manually below.
            </div>
        `;
    }
}

// Handle script execution
document.getElementById('runScriptForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    // Get selected target if any
    const selectedTarget = document.querySelector('input[name="selected_target"]:checked');
    if (selectedTarget) {
        data.target_id = selectedTarget.value;
    }
    
    data.save_results = document.getElementById('saveResults').checked;
    
    try {
        const response = await API.startExploit(
            data.script_id,
            data.target_url || data.target_id,
            {
                port: data.target_port,
                args: data.script_args,
                save_results: data.save_results
            }
        );
        
        currentExecutionId = response.execution_id;
        
        // Hide run modal and show log modal
        bootstrap.Modal.getInstance(document.getElementById('runScriptModal')).hide();
        showExecutionLog();
        
        API.showToast('Exploit script started successfully!', 'success');
        
    } catch (error) {
        API.showToast(error.message || 'Error starting exploit script', 'error');
    }
});

// Show execution log
function showExecutionLog() {
    // Initialize log viewer
    const logContainer = document.getElementById('executionLog');
    logViewer = new Components.LogViewer(logContainer, {
        executionId: currentExecutionId,
        autoScroll: true
    });
    
    // Show modal
    new bootstrap.Modal(document.getElementById('executionLogModal')).show();
    
    // Update status periodically
    const statusUpdater = setInterval(async () => {
        try {
            const response = await API.getExecutionStatus(currentExecutionId);
            const statusElement = document.getElementById('executionStatus');
            statusElement.className = `script-status ${response.status}`;
            statusElement.textContent = response.status.charAt(0).toUpperCase() + response.status.slice(1);
            
            if (['completed', 'failed', 'stopped'].includes(response.status)) {
                clearInterval(statusUpdater);
                document.getElementById('stopExecution').style.display = 'none';
            }
        } catch (error) {
            console.error('Error updating status:', error);
        }
    }, 2000);
    
    // Store interval ID for cleanup
    document.getElementById('executionLogModal').statusUpdater = statusUpdater;
}

// Stop execution
document.getElementById('stopExecution').addEventListener('click', async function() {
    if (!currentExecutionId) return;
    
    try {
        await API.stopExploit(currentExecutionId);
        API.showToast('Exploit execution stopped', 'warning');
        
        this.style.display = 'none';
        
    } catch (error) {
        API.showToast(error.message || 'Error stopping execution', 'error');
    }
});

// Download log
function downloadLog() {
    if (!logViewer || !currentExecutionId) return;
    
    const logContent = document.getElementById('executionLog').textContent;
    const blob = new Blob([logContent], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `exploit_log_${currentExecutionId}_${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}

// Delete script
function deleteScript(scriptId) {
    currentScriptId = scriptId;
    new bootstrap.Modal(document.getElementById('deleteScriptModal')).show();
}

// Confirm delete
document.getElementById('confirmDeleteScript').addEventListener('click', async function() {
    if (!currentScriptId) return;
    
    try {
        await API.deleteExploitScript(currentScriptId);
        
        API.showToast('Exploit script deleted successfully!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('deleteScriptModal')).hide();
        
        // Remove script card
        const scriptCard = document.querySelector(`[data-script-id="${currentScriptId}"]`);
        if (scriptCard) {
            scriptCard.remove();
        }
        
        // Check if no scripts left
        const remainingScripts = document.querySelectorAll('[data-script-id]');
        if (remainingScripts.length === 0) {
            location.reload();
        }
        
    } catch (error) {
        API.showToast(error.message || 'Error deleting script', 'error');
    }
});

// File upload handling
document.getElementById('scriptFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const uploadZone = document.querySelector('.file-upload-zone');
        uploadZone.innerHTML = `
            <div class="file-upload-icon">
                <i class="bi bi-file-earmark-code text-success"></i>
            </div>
            <div class="file-upload-text text-success">
                ${file.name} selected
            </div>
            <div class="file-upload-subtext">
                ${(file.size / 1024 / 1024).toFixed(2)} MB
            </div>
        `;
    }
});

// Cleanup on modal close
document.getElementById('executionLogModal').addEventListener('hidden.bs.modal', function() {
    if (logViewer) {
        logViewer.destroy();
        logViewer = null;
    }
    
    if (this.statusUpdater) {
        clearInterval(this.statusUpdater);
    }
});
</script>
{% endblock %}
